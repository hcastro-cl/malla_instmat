<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Editor de Mapa Curricular</title>
  <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #cy-container {
      position: relative;
      width: 80%;
      height: 800px;
      margin-bottom: 20px;
    }
    #cy {
      width: 100%;
      height: 100%;
      border: 1px solid #ccc;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      background-color: transparent;
    }
    #grid-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }
    .controls {
      margin: 15px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    button, select, textarea {
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
    }
    button:hover, select:hover {
      background-color: #f5f5f5;
    }
    #file-input, #node-editor {
      display: none;
    }
    #node-editor {
      position: absolute;
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      border-radius: 8px;
      width: 300px;
    }
    #node-editor label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    #node-editor input, #node-editor select, #node-editor textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #node-editor textarea {
      min-height: 80px;
    }
    #node-editor-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    #course-list-textarea {
      width: 100%;
      min-height: 100px;
      margin-bottom: 10px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.3);
      border-radius: 50%;
      border-top-color: #000;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
	.tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      max-width: 300px;
      z-index: 1000;
      pointer-events: none;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-line; /* Esto ayuda a mostrar los saltos de línea */
    }
    /* Estilos para la leyenda de colores */
    #semester-legend {
      margin-top: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    #semester-legend h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-right: 15px;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 8px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<div class="controls">
  <button onclick="loadServerGraph()">Cargar Malla Propuesta</button>
  <button onclick="saveGraph()">Guardar en Navegador</button>
  <button onclick="loadGraph()">Cargar desde Navegador</button>
  <button onclick="exportFullGraph()">Exportar Malla</button>
  <button onclick="document.getElementById('file-input').click()">Importar Malla</button>
  <button onclick="addNewNode()">Agregar Curso</button>
  <span id="loading-indicator" style="display:none;"><span class="loading"></span> Cargando...</span>
  <input type="file" id="file-input" accept=".json" />
	<img src="logo.png" alt="Logo" style="height:40px; margin-left:auto;">	
</div>

<!-- Nueva sección: Leyenda de colores por semestre -->
<div id="semester-legend">
  <div class="legend-items" id="legend-items-container">
    <!-- Los elementos de la leyenda se generarán automáticamente con JavaScript -->
  </div>
</div>

<div id="cy-container">
  <canvas id="grid-canvas"></canvas>
  <div id="cy"></div>
</div>

<div id="node-editor">
  <h3 style="margin-top: 0;">Editar Curso</h3>
  <label for="node-edit-title">Título del curso:</label>
  <input type="text" id="node-edit-title">
  
  <label for="node-edit-semester">Semestre:</label>
  <select id="node-edit-semester">
    <option value="0">No asignado</option>
    <option value="1">Semestre 1</option>
    <option value="2">Semestre 2</option>
    <option value="3">Semestre 3</option>
    <option value="4">Semestre 4</option>
    <option value="5">Semestre 5</option>
    <option value="6">Semestre 6</option>
    <option value="7">Semestre 7</option>
    <option value="8">Semestre 8</option>
    <option value="9">Semestre 9</option>
    <option value="10">Semestre 10</option>
  </select>
  
  <label for="node-edit-description">Descripción:</label>
  <textarea id="node-edit-description"></textarea>
  
  <div id="node-editor-buttons">
    <button onclick="saveNodeEdit()">Guardar</button>
    <button onclick="cancelNodeEdit()">Cancelar</button>
	<button onclick="deleteNode()">Eliminar Curso</button>
  </div>
</div>

<div id="tooltip" class="tooltip" style="display: none;"></div>

<script>
  // Lista de cursos por defecto
  let courseLabels = [
        "Introducción a las Matemáticas (Pre-Cálculo)",
    "Cálculo I",
    "Cálculo II",
    "Cálculo Avanzado",
    "Análisis Real",
    "Ecuaciones Diferenciales Parciales",
    "Teoría de la Medida",
    "Ecuaciones Diferenciales Ordinarias",
    "Análisis Complejo",
    "Análisis Numérico",
    "Matemáticas Discretas",
    "Álgebra",
    "Álgebra Lineal",
    "Álgebra Avanzada",
    "Optimización",
    "Álgebra Abstracta I",
    "Algebra Abstracta II",
    "Probabilidades",
    "Inferencia Estadística",
    "Procesos Estocásticos",
    "Programación I (Bioinformática) o Programación Estructurada (Videojuegos)",
    "Programación Avanzada (Bioinformática) o Programación orientada a objetos (Videojuegos)",
    "Algoritmos y Estructuras de Datos (Bioinformática)",
    "Bases de Datos (Bioinformática)",
    "Minería de Datos (Bioinformática)",
    "Visualización y Comunicación de Datos",
    "Introducción a la Ingeniería Matemática",
    "Laboratorio?",
    "Modelamiento Matemático",
    "Física General (Bioinformática)",
    "Electricidad y Magnetismo (Bioinformática)",
    "Ing. Económica y Evaluación de Proyectos (Ingeniería)",
    "Otro curso o un electivo?",
    "Electivo I",
    "Electivo II",
    "Electivo III",
    "Electivo IV",
    "Proyecto de titulo",
    "Trabajo de titulo",
	"Formacion fundamental I",
	"Formacion fundamental II",
	"Formacion fundamental III",
	"Formacion fundamental IV",
	"Idioma I",
	"Idioma II",
	"Idioma III",
	"Idioma IV",
	"Minor I",
	"Minor II",
	"Minor III",
	"Minor IV"
  ];

  // Colores por semestre
  const semesterColors = {
    0: '#6bb1f8',  // No asignado (azul claro)
    1: '#FF9AA2',  // Semestre 1 (rojo claro)
    2: '#FFB7B2',  // Semestre 2 (rojo más claro)
    3: '#FFDAC1',  // Semestre 3 (naranja claro)
    4: '#E2F0CB',  // Semestre 4 (verde claro)
    5: '#B5EAD7',  // Semestre 5 (verde agua)
    6: '#C7CEEA',  // Semestre 6 (azul lavanda)
    7: '#A2D7D8',  // Semestre 7 (turquesa)
    8: '#A5BAD7',  // Semestre 8 (verde menta)
    9: '#D8B5FF',  // Semestre 9 (lavanda)
    10: '#BB9AA2'  // Semestre 10 (igual al 1 para completar)
  };

  // Nombres de semestres para la leyenda
  const semesterNames = {
    0: "No asignado",
    1: "Semestre 1",
    2: "Semestre 2",
    3: "Semestre 3",
    4: "Semestre 4",
    5: "Semestre 5",
    6: "Semestre 6",
    7: "Semestre 7",
    8: "Semestre 8",
    9: "Semestre 9",
    10: "Semestre 10"
  };

  // Variables globales
  let elements = [];
  let cy;
  let selectedNode = null;
  let currentlyEditingNode = null;
  const COLUMNS = 11;
  const ROWS = 1;
  const COLUMN_WIDTH = 150;
  const ROW_HEIGHT = 150;
  
  function formatDescriptionText(text) {
    if (!text) return '';
    // Convertir saltos de línea en <br> y mantener múltiples espacios
    return text.replace(/\n/g, '<br>');
  }

  // Función para crear la leyenda de colores
  function createColorLegend() {
    const container = document.getElementById('legend-items-container');
    container.innerHTML = '';
    
    // Ordenar los semestres (0 al final)
    const sortedSemesters = Object.keys(semesterColors)
      .map(Number)
      .sort((a, b) => {
        if (a === 0) return 1;
        if (b === 0) return -1;
        return a - b;
      });
    
    sortedSemesters.forEach(semester => {
      const item = document.createElement('div');
      item.className = 'legend-item';
      
      const colorBox = document.createElement('div');
      colorBox.className = 'legend-color';
      colorBox.style.backgroundColor = semesterColors[semester];
      
      const label = document.createElement('span');
      label.textContent = semesterNames[semester];
      
      item.appendChild(colorBox);
      item.appendChild(label);
      container.appendChild(item);
    });
  }

  // Función para dibujar la cuadrícula de fondo
  function drawGrid() {
    const canvas = document.getElementById('grid-canvas');
    const ctx = canvas.getContext('2d');
    const width = canvas.width = canvas.offsetWidth;
    const height = canvas.height = canvas.offsetHeight;
    
    ctx.clearRect(0, 0, width, height);
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 1;
    
    // Dibujar líneas verticales (columnas)
    for (let i = 0; i <= COLUMNS; i++) {
      const x = i * (width / COLUMNS);
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, height);
      ctx.stroke();
    }
    
    // Dibujar líneas horizontales (filas)
    for (let i = 0; i <= ROWS; i++) {
      const y = i * (height / ROWS);
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(width, y);
      ctx.stroke();
    }
  }

  // Inicializar el gráfico
  function initializeGraph() {
    // Redibujar la cuadrícula
    drawGrid();
    
    // Volver a dibujar cuando cambie el tamaño
    window.addEventListener('resize', drawGrid);
    
    // Limpiar gráfico existente
    if (cy) {
      cy.destroy();
    }

    // Crear nodos con posiciones en cuadrícula de 10 columnas
    elements = [];
    
    courseLabels.forEach((label, index) => {
      const row = Math.floor(index / COLUMNS);
      const col = index % COLUMNS;
      const id = 'n' + index;
      
      elements.push({ 
        data: { 
          id, 
          label,
          title: label,  // Inicialmente el título es igual al label
          semester: 0,   // Semestre no asignado por defecto
          description: "" // Descripción vacía por defecto
        },
        position: { 
          x: col * COLUMN_WIDTH + 100, 
          y: row * ROW_HEIGHT + 100 
        }
      });
    });

    cy = cytoscape({
      container: document.getElementById('cy'),
      elements: elements,
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(title)',
            'text-valign': 'center',
            'text-halign': 'center',
            'text-wrap': 'wrap',
            'text-max-width': '110px',
            'background-color': 'data(color)',
            'shape': 'roundrectangle',
            'width': 'label',
            'height': 'label',
            'padding': '12px',
            'font-size': '13px',
            'border-width': '0px',
            'border-color': '#f00'
          }
        },
        {
          selector: 'node:selected',
          style: {
            'background-color': '#f55',
            'border-width': '3px'
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 2,
            'line-color': '#aaa',
            'target-arrow-color': '#aaa',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'label': 'data(label)',
            'text-rotation': 'autorotate',
            'text-margin-x': '10px',
            'text-margin-y': '10px',
            'font-size': '10px'
          }
        }
      ],
      layout: {
        name: 'preset'
      },
	  //userZoomingEnabled: false
    });

    // Asignar colores iniciales basados en semestre
    cy.nodes().forEach(node => {
      updateNodeColor(node);
    });

    // Lógica para crear conexiones
    cy.on('tap', 'node', function(evt){
      const node = evt.target;
      if (!selectedNode) {
        selectedNode = node;
        node.addClass('selected');
      } else if (selectedNode === node) {
        selectedNode.removeClass('selected');
        selectedNode = null;
      } else {
        cy.add({ 
          group: 'edges', 
          data: { 
            source: selectedNode.id(), 
            target: node.id(),
          } 
        });
        selectedNode.removeClass('selected');
        selectedNode = null;
      }
    });

    // Eliminar conexión al hacer clic
    cy.on('tap', 'edge', function(evt){
      evt.target.remove();
    });

    // Editar nodo al hacer doble clic
    cy.on('dbltap', 'node', function(evt){
      const node = evt.target;
      currentlyEditingNode = node;
      const editor = document.getElementById('node-editor');
      document.getElementById('node-edit-title').value = node.data('title');
      document.getElementById('node-edit-semester').value = node.data('semester') || 0;
      document.getElementById('node-edit-description').value = node.data('description') || '';
      
      // Posicionar editor cerca del nodo
      const nodePos = node.renderedPosition();
      editor.style.left = (nodePos.x + 20) + 'px';
      editor.style.top = (nodePos.y + 20) + 'px';
      editor.style.display = 'block';
      
      // Enfocar el primer campo
      document.getElementById('node-edit-title').focus();
    });

    // Mostrar tooltip con descripción al pasar el mouse
  cy.on('mouseover', 'node', function(evt){
    const node = evt.target;
    const description = node.data('description');
    if (description && description.trim() !== '') {
      const tooltip = document.getElementById('tooltip');
      const formattedDesc = formatDescriptionText(description);
      tooltip.innerHTML = `<strong>${node.data('title')}</strong><br>${formattedDesc}`;
      tooltip.style.display = 'block';
      
      // Actualizar posición mientras el mouse se mueve
      cy.on('mousemove', function(e) {
        if (e.originalEvent) {
          tooltip.style.left = (e.originalEvent.clientX + 10) + 'px';
          tooltip.style.top = (e.originalEvent.clientY + 10) + 'px';
        }
      });
    }
  });

    // Ocultar tooltip al quitar el mouse
    cy.on('mouseout', 'node', function(){
      document.getElementById('tooltip').style.display = 'none';
      cy.off('mousemove');
    });
  }

  // Actualizar color del nodo basado en el semestre
  function updateNodeColor(node) {
    const semester = node.data('semester') || 0;
    node.data('color', semesterColors[semester]);
  }

  // Inicializar el gráfico y la leyenda
  initializeGraph();
  createColorLegend();

  // Funciones para editar nodos
  function saveNodeEdit() {
    if (currentlyEditingNode) {
      const newTitle = document.getElementById('node-edit-title').value;
      const newSemester = parseInt(document.getElementById('node-edit-semester').value);
      const newDescription = document.getElementById('node-edit-description').value;
      
      currentlyEditingNode.data('title', newTitle);
      currentlyEditingNode.data('semester', newSemester);
      currentlyEditingNode.data('description', newDescription);
      
      // Actualizar el label (texto visible) con el título
      currentlyEditingNode.data('label', newTitle);
      
      // Actualizar color basado en semestre
      updateNodeColor(currentlyEditingNode);
      
      cancelNodeEdit();
    }
  }

  function cancelNodeEdit() {
    document.getElementById('node-editor').style.display = 'none';
    currentlyEditingNode = null;
  }

  // Editar lista de cursos
  function showCourseListEditor() {
    const editor = document.getElementById('course-list-editor');
    document.getElementById('course-list-textarea').value = courseLabels.join('\n');
    editor.style.display = 'block';
  }

  function updateCoursesFromText() {
    const newText = document.getElementById('course-list-textarea').value;
    courseLabels = newText.split('\n').filter(line => line.trim() !== '');
    document.getElementById('course-list-editor').style.display = 'none';
    initializeGraph();
  }

  // Cambiar disposición
  function changeLayout() {
    const layoutName = document.getElementById('layout-selector').value;
    if (layoutName === 'preset') {
      cy.nodes().positions(function(node) {
        return node.position();
      });
      return;
    }
    
    cy.layout({
      name: layoutName,
      animate: true,
      animationDuration: 500
    }).run();
  }

  // Exportar conexiones
  function downloadEdges() {
    const edges = cy.edges().map(edge => ({
      source: cy.getElementById(edge.data('source')).data('title'),
      target: cy.getElementById(edge.data('target')).data('title'),
      relationship: edge.data('label')
    }));

    const blob = new Blob([JSON.stringify(edges, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "conexiones_cursos.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  // Exportar mapa completo
  function exportFullGraph() {
    const graphData = {
      nodes: cy.nodes().map(node => ({
        id: node.id(),
        title: node.data('title'),
        semester: node.data('semester'),
        description: node.data('description'),
        position: node.position()
      })),
      edges: cy.edges().map(edge => ({
        source: edge.data('source'),
        target: edge.data('target'),
        label: edge.data('label')
      })),
      courseLabels: courseLabels
    };
    
    const blob = new Blob([JSON.stringify(graphData, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "mapa_curricular_completo.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  // Guardar en el navegador
  function saveGraph() {
    const graphData = {
      nodes: cy.nodes().map(node => ({
        id: node.id(),
        title: node.data('title'),
        semester: node.data('semester'),
        description: node.data('description'),
        position: node.position()
      })),
      edges: cy.edges().map(edge => ({
        source: edge.data('source'),
        target: edge.data('target'),
        label: edge.data('label')
      })),
      courseLabels: courseLabels
    };
    
    localStorage.setItem('courseGraphComplete', JSON.stringify(graphData));
    alert('¡Mapa guardado en el navegador!');
  }

  // Cargar desde el navegador
  function loadGraph() {
    const saved = localStorage.getItem('courseGraphComplete');
    if (saved) {
      const graphData = JSON.parse(saved);
      if (graphData.courseLabels) {
        courseLabels = graphData.courseLabels;
      }
      loadGraphData(graphData);
      alert('¡Mapa cargado desde el navegador!');
    } else {
      alert('¡No se encontró ningún mapa guardado en el navegador!');
    }
  }

  // Importar archivo
  document.getElementById('file-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const graphData = JSON.parse(e.target.result);
        if (graphData.courseLabels) {
          courseLabels = graphData.courseLabels;
        }
        loadGraphData(graphData);
        alert('¡Mapa importado correctamente!');
      } catch (error) {
        alert('Error al importar: ' + error.message);
      }
    };
    reader.readAsText(file);
  });

  // Cargar mapa predeterminado del servidor
  function loadServerGraph() {
    showLoading(true);
    fetch('malla-default.json')
      .then(response => {
        if (!response.ok) throw new Error('Error en la respuesta del servidor');
        return response.json();
      })
      .then(graphData => {
        if (graphData.courseLabels) {
          courseLabels = graphData.courseLabels;
        }
        loadGraphData(graphData);
        alert('¡Mapa predeterminado cargado desde el servidor!');
      })
      .catch(error => {
        alert('Error al cargar del servidor: ' + error.message);
        initializeGraph();
      })
      .finally(() => showLoading(false));
  }

  // Función para cargar datos del gráfico
  function loadGraphData(graphData) {
    if (graphData.courseLabels) {
      courseLabels = graphData.courseLabels;
    }
    
    initializeGraph();
    
    if (graphData.nodes) {
      graphData.nodes.forEach(node => {
        const cyNode = cy.getElementById(node.id);
        if (cyNode) {
          // Actualizar todos los atributos del nodo
          cyNode.data('title', node.title || node.label || '');
          cyNode.data('semester', node.semester || 0);
          cyNode.data('description', node.description || '');
          cyNode.data('label', node.title || node.label || '');
          
          // Actualizar posición si existe
          if (node.position) {
            cyNode.position(node.position);
          }
          
          // Actualizar color basado en semestre
          updateNodeColor(cyNode);
        }
      });
    }
    
    if (graphData.edges) {
      graphData.edges.forEach(edge => {
        cy.add({
          group: 'edges',
          data: {
            source: edge.source,
            target: edge.target,
            label: edge.label
          }
        });
      });
    }
    
    cy.layout({ name: 'preset' }).run();
  }

  // Limpiar conexiones
  function clearGraph() {
    if (confirm('¿Estás seguro de que quieres eliminar todas las conexiones?')) {
      cy.edges().remove();
    }
  }

  // Reiniciar posiciones a la cuadrícula de 10 columnas
  function resetNodePositions() {
    if (confirm('¿Restablecer todas las posiciones a la cuadrícula predeterminada?')) {
      cy.nodes().forEach((node, index) => {
        const row = Math.floor(index / COLUMNS);
        const col = index % COLUMNS;
        node.position({
          x: col * COLUMN_WIDTH + 100,
          y: row * ROW_HEIGHT + 100
        });
      });
      
      cy.layout({ name: 'preset' }).run();
    }
  }

  // Mostrar indicador de carga
  function showLoading(show) {
    document.getElementById('loading-indicator').style.display = show ? 'inline-block' : 'none';
  }

  // Al cargar la página: intentar cargar del navegador primero, luego del servidor
  window.addEventListener('load', function() {
    const saved = localStorage.getItem('courseGraphComplete');
    if (saved) {
      loadGraph();
    } else {
      loadServerGraph();
    }
  });
  
  let newNodeCount = 0;

function addNewNode() {
  // Crear un ID único para el nuevo nodo
  const id = 'new' + newNodeCount++;
  
  // Crear la posición para el nuevo nodo
  const position = {
    x: 100 + (cy.nodes().length % COLUMNS) * COLUMN_WIDTH,
    y: 100 + Math.floor(cy.nodes().length / COLUMNS) * ROW_HEIGHT
  };
  
  // Agregar el nodo al gráfico
  const newNode = cy.add({
    group: 'nodes',
    data: {
      id: id,
      title: "Nuevo Curso",
      semester: 0,
      description: "",
      label: "Nuevo Curso",
      color: semesterColors[0]
    },
    position: position
  });

  // Actualizar el color del nuevo nodo
  updateNodeColor(newNode);
}

function deleteNode() {
  if (currentlyEditingNode) {
    const nodeTitle = currentlyEditingNode.data('title');
    if (confirm(`¿Seguro que deseas eliminar el curso "${nodeTitle}"?`)) {
      cy.remove(currentlyEditingNode);
      cancelNodeEdit();
    }
  }
}


</script>

</body>
</html>
